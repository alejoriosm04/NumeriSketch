{% extends "base/base.html" %}
{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Page Content -->
<div class="container mt-5 pt-5">
  <div class="row justify-content-center">
    <div class="col-lg-8 text-center">
      <h1 class="mt-5 section-t">Método de Jacobi</h1>
      <p class="lead">El método de Jacobi es un procedimiento iterativo para resolver sistemas de ecuaciones lineales.</p>
    </div>
  </div>

  <!-- Mostrar mensaje de error -->
  {% if error %}
  <div class="row justify-content-center mt-4">
    <div class="col-lg-8">
      <div class="alert alert-danger" role="alert">
        {{ error }}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Form for entering matrix size and inputs -->
  <div class="row justify-content-center mt-4">
    <div class="col-lg-8">
      <div class="card p-4 shadow-lg">
        <form method="POST" action="{% url 'jacobi' %}">
          {% csrf_token %}
          <div class="form-group mb-3">
            <label for="matrix_size">Tamaño de la Matriz:</label>
            <select id="matrix_size" name="matrix_size" class="form-control" required onchange="generateMatrixFields()">
                {% for i in range_matrices %}
                <option value="{{ i }}" {% if matrix_size|length == i %}selected{% endif %}>{{ i }}x{{ i }}</option>
                {% endfor %}
            </select>
          </div>

          <!-- Example and Random Generation Buttons -->
          <div class="mb-3">
            <button type="button" class="btn btn-lightblue" onclick="loadExample(1)">Cargar Ejemplo 1</button>
            <button type="button" class="btn btn-lightblue" onclick="loadExample(2)">Cargar Ejemplo 2</button>
            <button type="button" class="btn btn-lightblue" onclick="loadExample(3)">Cargar Ejemplo 3</button>
            <button type="button" class="btn btn-lightblue" onclick="generateRandomValues()">Generar Números Aleatorios</button>
          </div>

          <!-- Matrix and Vectors together -->
          <div id="matrix_inputs_container" class="form-group mb-3">
            <div class="d-flex justify-content-center">
              <!-- Matrix A -->
              <div class="matrix-container">
                <label class="matrix-label">Matriz A</label>
                <table class="matrix-table">
                  {% for i in matrix_size %}
                  <tr>
                    {% for j in matrix_size %}
                    <td>
                      <input type="number" name="A_{{ i }}_{{ j }}" class="matrix-input" 
                             placeholder="A[{{ i|add:1 }}][{{ j|add:1 }}]" step="any" 
                             value="{{ original_matrix|default_if_none:''|slice:i|default:''|slice:j|default:'' }}">
                    </td>
                    {% endfor %}
                  </tr>
                  {% endfor %}
                </table>
              </div>
          
              <!-- Vector b -->
              <div class="vector-container mx-3">
                <label class="matrix-label">Vector b</label>
                <table class="matrix-table">
                  {% for i in matrix_size %}
                  <tr>
                    <td>
                      <input type="number" name="b_{{ i }}" class="matrix-input" 
                             placeholder="b[{{ i|add:1 }}]" step="any" 
                             value="{{ b_values|default_if_none:''|slice:i|default:'' }}">
                    </td>
                  </tr>
                  {% endfor %}
                </table>
              </div>
          
              <!-- Vector x0 -->
              <div class="vector-container">
                <label class="matrix-label">Vector x0</label>
                <table class="matrix-table">
                  {% for i in matrix_size %}
                  <tr>
                    <td>
                      <input type="number" name="x0_{{ i }}" class="matrix-input" 
                             placeholder="x0[{{ i|add:1 }}]" step="any" 
                             value="{{ x0_values|default_if_none:''|slice:i|default:'' }}">
                    </td>
                  </tr>
                  {% endfor %}
                </table>
              </div>
            </div>
          </div>
          

          <!-- Tolerance and Iterations -->
          <div class="form-group mb-3">
            <label for="tol">Tolerancia:</label>
            <input type="number" id="tol" name="tol" class="form-control rounded shadow-sm" step="any" placeholder="Ejemplo: 0.5e-5" value="{{ tol|default_if_none:0 }}" required>
          </div>
          <div class="form-group mb-3">
            <label for="niter">Número de Iteraciones:</label>
            <input type="number" id="niter" name="niter" class="form-control rounded shadow-sm" step="any" min="1" placeholder="Ejemplo: 100" value="{{ niter|default_if_none:100 }}" required>
          </div>

          <!-- Submit Button -->
          <button type="button" class="btn btn-primary btn-lg w-100 shadow-sm" onclick="validateAndSubmit()">Calcular</button>

          <!-- Reset Button -->
          <button type="reset" class="btn btn-secondary btn-lg w-100 mt-3 shadow-sm">Limpiar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Display Iteration Table Below the Inputs -->
  {% if iteration_table %}
  <div class="row justify-content-center mt-4">
    <div class="col-lg-8">
      <h3>Tabla de Iteraciones:</h3>
      <table class="table table-striped table-bordered shadow-sm">
        <thead class="table-dark">
          <tr>
            <th>Iteración</th>
            {% for x in x0_values %}
              <th>x_{{ forloop.counter }}</th>
            {% endfor %}
            <th>Error</th>
          </tr>
        </thead>
        <tbody>
          {% for iteration, x_values, error in iteration_table %}
          <tr>
            <td>{{ iteration }}</td>
            {% for x in x_values %}
              <td>{{ x|floatformat:6 }}</td>
            {% endfor %}
            <td>{{ error|floatformat:6 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>


<!-- Custom Styles for Matrix and Hover Effects -->
<style>
  body, .card, h1, p, label, .form-control, button {
    font-family: 'Poppins', sans-serif;
  }
  .matrix-table {
    border-spacing: 5px;
  }
  .matrix-input {
    width: 60px;
    height: 40px;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  .matrix-input:hover {
    background-color: #e0f7fa;
  }
  .matrix-container {
    display: inline-block;
  }
  .vector-container {
    display: inline-block;
  }
  .btn-lightblue {
    background-color: #4A90E2;
    color: #fff;
  }
  .btn-lightblue:hover {
    background-color: #357ABD;
    color: #fff;
  }
  .matrix-container {
    background-color: #e3f2fd;
    padding: 10px;
    border: 2px solid #64b5f6;
    margin-right: 15px;
  }
  .vector-container {
    background-color: #f3e5f5;
    padding: 10px;
    border: 2px solid #ba68c8;
  }
  .matrix-label {
    font-weight: bold;
    margin-bottom: 10px;
  }
</style>

<script>
  function validateAndSubmit() {
    const matrixSize = document.getElementById('matrix_size').value;
    let emptyInputs = false;
    let inputsToCheck = [];

    // Check matrix inputs
    for (let i = 0; i < matrixSize; i++) {
      for (let j = 0; j < matrixSize; j++) {
        const input = document.querySelector(`input[name="A_${i}_${j}"]`);
        if (input && input.value.trim() === '') {
          emptyInputs = true;
          inputsToCheck.push(`A[${i+1}][${j+1}]`);
        }
      }
    }

    // Check vector b inputs
    for (let i = 0; i < matrixSize; i++) {
      const input = document.querySelector(`input[name="b_${i}"]`);
      if (input && input.value.trim() === '') {
        emptyInputs = true;
        inputsToCheck.push(`b[${i+1}]`);
      }
    }

    // Check vector x0 inputs
    for (let i = 0; i < matrixSize; i++) {
      const input = document.querySelector(`input[name="x0_${i}"]`);
      if (input && input.value.trim() === '') {
        emptyInputs = true;
        inputsToCheck.push(`x0[${i+1}]`);
      }
    }

    if (emptyInputs) {
      const message = `Los siguientes campos estarán llenos con 0: ${inputsToCheck.join(', ')}. ¿Desea continuar?`;
      if (confirm(message)) {
        for (let i = 0; i < matrixSize; i++) {
          for (let j = 0; j < matrixSize; j++) {
            const input = document.querySelector(`input[name="A_${i}_${j}"]`);
            if (input && input.value.trim() === '') {
              input.value = 0;
            }
          }
        }
        for (let i = 0; i < matrixSize; i++) {
          const input = document.querySelector(`input[name="b_${i}"]`);
          if (input && input.value.trim() === '') {
            input.value = 0;
          }
          const inputX0 = document.querySelector(`input[name="x0_${i}"]`);
          if (inputX0 && inputX0.value.trim() === '') {
            inputX0.value = 0;
          }
        }
        document.querySelector('form').submit();
      }
    } else {
      // Almacenar la entrada del usuario en el almacenamiento local
      const matrixSize = document.getElementById('matrix_size').value;
      for (let i = 0; i < matrixSize; i++) {
          for (let j = 0; j < matrixSize; j++) {
              const inputA = document.querySelector(`input[name="A_${i}_${j}"]`);
              localStorage.setItem(`A_${i}_${j}`, inputA.value);

              const inputB = document.querySelector(`input[name="b_${i}"]`);
              localStorage.setItem(`b_${i}`, inputB.value);

              const inputX0 = document.querySelector(`input[name="x0_${i}"]`);
              localStorage.setItem(`x0_${i}`, inputX0.value);
          }
      }

      document.querySelector('form').submit();
  }
  }

  function generateMatrixFields() {
    const matrixSize = document.getElementById('matrix_size').value;
    const matrixContainer = document.getElementById('matrix_inputs_container');
    
    // Clear any existing inputs
    matrixContainer.innerHTML = '';
  
    let html = '<div class="d-flex justify-content-center">';
    
    // Generate matrix A fields
    html += '<div class="matrix-container"><label class="matrix-label">Matriz A</label><table class="matrix-table">';
    for (let i = 0; i < matrixSize; i++) {
      html += '<tr>';
      for (let j = 0; j < matrixSize; j++) {
        html += `<td><input type="number" name="A_${i}_${j}" class="matrix-input" placeholder="A[${i+1}][${j+1}]" step="any"></td>`;
      }
      html += '</tr>';
    }
    html += '</table></div>';
  
    // Generate vector b fields
    html += '<div class="vector-container mx-3"><label class="matrix-label">Vector b</label><table class="matrix-table">';
    for (let i = 0; i < matrixSize; i++) {
      html += `<tr><td><input type="number" name="b_${i}" class="matrix-input" placeholder="b[${i+1}]" step="any"></td></tr>`;
    }
    html += '</table></div>';
  
    // Generate vector x0 fields
    html += '<div class="vector-container"><label class="matrix-label">Vector x0</label><table class="matrix-table">';
    for (let i = 0; i < matrixSize; i++) {
      html += `<tr><td><input type="number" name="x0_${i}" class="matrix-input" placeholder="x0[${i+1}]" step="any"></td></tr>`;
    }
    html += '</table></div></div>';
  
    // Insert generated HTML into container
    matrixContainer.innerHTML = html;
  }
  
  function loadExample(exampleNumber) {
    let matrixSize = 3;
    let matrixA = [
      [2, -1, 0],
      [-1, 2, -1],
      [0, -1, 2]
    ];
    let vectorB = [1, 0, 1];
    let vectorX0 = [0, 0, 0];

    if (exampleNumber === 2) {
      matrixSize = 4;
      matrixA = [
        [45, 13, -4, 8],
        [-5, -28, 4, -14],
        [9, 15, 63, -7],
        [2, 3, -8, -42]
      ];
      vectorB = [-25, 82, 75, -43];
      vectorX0 = [2, 2, 2, 2];
    }

    if (exampleNumber === 3) {
      matrixA = [
        [10, 2, 1],
        [2, 20, -2],
        [1, -2, 30]
      ];
      vectorB = [7, -3, 8];
      vectorX0 = [0, 0, 0];
    }

    document.getElementById('matrix_size').value = matrixSize;
    generateMatrixFields();

    for (let i = 0; i < matrixSize; i++) {
      for (let j = 0; j < matrixSize; j++) {
        const input = document.querySelector(`input[name="A_${i}_${j}"]`);
        if (input) {
          input.value = matrixA[i][j];
        }
      }
    }

    for (let i = 0; i < matrixSize; i++) {
      const input = document.querySelector(`input[name="b_${i}"]`);
      if (input) {
        input.value = vectorB[i];
      }
      const inputX0 = document.querySelector(`input[name="x0_${i}"]`);
      if (inputX0) {
        inputX0.value = vectorX0[i];
      }
    }
  }

  function generateRandomValues() {
    const matrixSize = document.getElementById('matrix_size').value;
    generateMatrixFields();

    for (let i = 0; i < matrixSize; i++) {
      for (let j = 0; j < matrixSize; j++) {
        const input = document.querySelector(`input[name="A_${i}_${j}"]`);
        if (input) {
          input.value = (Math.random() * 20 - 10).toFixed(2);
        }
      }
    }

    for (let i = 0; i < matrixSize; i++) {
      const input = document.querySelector(`input[name="b_${i}"]`);
      if (input) {
        input.value = (Math.random() * 20 - 10).toFixed(2);
      }
      const inputX0 = document.querySelector(`input[name="x0_${i}"]`);
      if (inputX0) {
        inputX0.value = (Math.random() * 20 - 10).toFixed(2);
      }
    }
  }
</script>

{% endblock %}

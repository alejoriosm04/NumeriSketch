{% extends "base/base.html" %}
{% load static %}
{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Page Content -->
<div class="container mt-5 pt-5">
  <div class="row justify-content-center">
    <div class="col-lg-8 text-center">
      <h1 class="mt-5 section-t">Método de Gauss-Seidel</h1>
      <p class="lead">El método de Gauss-Seidel es un procedimiento iterativo para resolver sistemas de ecuaciones lineales.</p>
      <!-- Botón de ayuda desplegable -->
      <button class="btn btn-info mt-3" type="button" data-bs-toggle="collapse" data-bs-target="#helpSection" aria-expanded="false" aria-controls="helpSection">
        Mostrar Ayuda
      </button>

      <!-- Sección de ayuda desplegable -->
      <div class="collapse mt-3" id="helpSection">
        <div class="card card-body">
          <h3 class="text-center">Consideraciones Importantes</h3>
          <ul class="list-group list-group-flush text-center">
            <li class="list-group-item">La matriz debe ser diagonal dominante para garantizar la convergencia.</li>
            <li class="list-group-item">El método utiliza las actualizaciones inmediatas de las variables, lo que puede acelerar la convergencia.</li>
            <li class="list-group-item">El número de iteraciones debe ser positivo.</li>
            <li class="list-group-item">La tolerancia también debe ser un valor positivo.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Mostrar mensaje de error -->
  {% if error %}
  <div class="row justify-content-center mt-4">
    <div class="col-lg-8">
      <div class="alert alert-danger" role="alert">
        {{ error }}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Formulario para ingresar tamaño de matriz e inputs -->
  <div class="row justify-content-center mt-4 mb-4">
    <div class="col-lg-8">
      <div class="card p-4 shadow-lg">
        <form method="POST" action="{% url 'gauss_seidel' %}">
          {% csrf_token %}
          <div class="form-group mb-3">
            <label for="matrix_size">Tamaño de la Matriz:</label>
            <select id="matrix_size" name="matrix_size" class="form-control" required onchange="generateMatrixFields()">
              {% for i in range_matrices %}
                <option value="{{ i }}" {% if matrix_size|length == i %}selected{% endif %}>{{ i }}x{{ i }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Botones de ejemplo y generación aleatoria -->
          <div class="mb-3">
            <button type="button" class="btn btn-lightblue" onclick="loadExample(1)">Cargar Ejemplo 1</button>
            <button type="button" class="btn btn-lightblue" onclick="loadExample(2)">Cargar Ejemplo 2</button>
            <button type="button" class="btn btn-lightblue" onclick="generateRandomValues()">Generar Números Aleatorios</button>
          </div>

          <!-- Matrix and Vectors together -->
          <div id="matrix_inputs_container" class="form-group mb-3">
            <!-- Los inputs de la matriz serán generados dinámicamente aquí -->
          </div>

          <!-- Tolerancia e Iteraciones -->
          <div class="form-group mb-3">
            <label for="tol">Tolerancia:</label>
            <input type="number" id="tol" name="tol" class="form-control rounded shadow-sm" step="any" min="0" placeholder="Ejemplo: 0.001" value="{{ tol|default:'' }}" required>
          </div>
          <div class="form-group mb-3">
            <label for="niter">Número de Iteraciones:</label>
            <input type="number" id="niter" name="niter" class="form-control rounded shadow-sm" step="any" min="1" placeholder="Ejemplo: 100" value="{{ niter|default:'' }}" required>
          </div>

          <!-- Botón de Calcular -->
          <button type="submit" class="btn btn-primary btn-lg w-100 shadow-sm">Calcular</button>

          <!-- Botón de Limpiar -->
          <button type="reset" class="btn btn-secondary btn-lg w-100 mt-3 shadow-sm">Limpiar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Mostrar resultados -->
  {% if original_matrix %}
  <div class="row justify-content-center mt-4">
    <div class="col-lg-8">
      <div class="card p-4 shadow-lg">
        <h3 class="text-center">Matriz Original Ingresada:</h3>
        <table class="table table-striped table-bordered shadow-sm">
          <tbody>
            {% for row in original_matrix %}
              <tr>
                {% for value in row %}
                  <td>{{ value|floatformat:2 }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  {% if b_values and x0_values %}
  <div class="row justify-content-center mt-4">
    <div class="col-lg-4">
      <div class="card p-4 shadow-lg">
        <h4 class="text-center">Vector b:</h4>
        <ul class="list-group">
          {% for value in b_values %}
            <li class="list-group-item">{{ value|floatformat:2 }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card p-4 shadow-lg">
        <h4 class="text-center">Vector Inicial x0:</h4>
        <ul class="list-group">
          {% for value in x0_values %}
            <li class="list-group-item">{{ value|floatformat:2 }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  {% endif %}

  {% if spectral_radius %}
  <div class="row justify-content-center mt-4">
    <div class="col-lg-8">
      <div class="alert alert-info text-center" role="alert">
        <strong>Radio Espectral:</strong> {{ spectral_radius|floatformat:6 }}
        <p class="mt-2">
          El radio espectral en Gauss-Seidel indica si el método puede converger: si es menor que 1, garantiza convergencia. Sin embargo, en ciertos casos, el método puede converger aunque el radio espectral sea ligeramente mayor que 1, dependiendo de la matriz y las condiciones iniciales.
        </p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Mostrar Tabla de Iteraciones -->
  {% if iteration_table %}
  <div class="row justify-content-center mt-4">
    <div class="col-lg-8">
      <div class="card p-4 shadow-lg">
        {% if result_message %}
        <p class="text-center {% if "Fracasó" in result_message %}text-danger{% else %}text-success{% endif %}">
          {{ result_message }}
        </p>
        {% endif %}

        {% if error %}
        <div class="alert alert-danger" role="alert">
          {{ error }}
        </div>
        {% endif %}

        <h3 class="text-center">Tabla de Iteraciones:</h3>
        <div style="overflow-x: auto;">
          <table class="table table-striped table-bordered shadow-sm">
            <thead class="table-dark">
              <tr>
                <th>Iteración</th>
                {% for x in x0_values %}
                  <th>x_{{ forloop.counter }}</th>
                {% endfor %}
                <th>Error</th>
              </tr>
            </thead>
            <tbody>
              {% for iteration, x_values, error in iteration_table %}
              <tr>
                <td>{{ iteration }}</td>
                {% for x in x_values %}
                  <td>{{ x|floatformat:6 }}</td>
                {% endfor %}
                <td>{{ error|floatformat:6 }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Mostrar gráfica si está disponible -->
  {% if graph_png and graph_svg %}
  <div class="mt-4 text-center">
    <h3>Gráfica del Sistema de Ecuaciones:</h3>
    <img src="{% static 'graphs/gauss_seidel_system.png' %}" alt="Gráfica del Sistema de Ecuaciones" class="img-fluid" />
    <div class="mt-3">
      <a href="{% static 'graphs/gauss_seidel_system.png' %}" download="gauss_seidel_system.png" class="btn btn-custom btn-primary me-2">Descargar como PNG</a>
      <a href="{% static 'graphs/gauss_seidel_system.svg' %}" download="gauss_seidel_system.svg" class="btn btn-custom btn-orange">Descargar como SVG</a>
    </div>
  </div>
  {% endif %}

  {% endif %}

</div>

<!-- Custom Styles and Scripts -->
<style>
  body,
  .card,
  h1,
  p,
  label,
  .form-control,
  button {
    font-family: 'Poppins', sans-serif;
  }
  .matrix-table {
    border-spacing: 5px;
  }
  .matrix-input {
    width: 60px;
    height: 40px;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  .matrix-input:hover {
    background-color: #e0f7fa;
  }
  .matrix-container {
    display: inline-block;
    background-color: #e3f2fd;
    padding: 10px;
    border: 2px solid #64b5f6;
    margin-right: 15px;
  }
  .vector-container {
    display: inline-block;
    background-color: #f3e5f5;
    padding: 10px;
    border: 2px solid #ba68c8;
  }
  .matrix-label {
    font-weight: bold;
    margin-bottom: 10px;
  }
  .btn-custom {
    width: 220px;
    height: 50px;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    border-radius: 5px;
  }
  .btn-primary {
    background-color: #007bff;
    border: none;
  }
  .btn-primary:hover {
    background-color: #0056b3;
  }
  .btn-orange {
    background-color: #ff9800;
    color: white;
    border: none;
  }
  .btn-orange:hover {
    background-color: #e68900;
  }
  .btn-orange:focus {
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(255, 152, 0, 0.5);
  }
  .btn-lightblue {
    background-color: #00aaff;
    color: white;
    border: none;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 5px;
    transition: background-color 0.3s ease;
  }
  .btn-lightblue:hover {
    background-color: #008fcc;
  }
  .btn-lightblue:focus {
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(0, 175, 255, 0.5);
  }
  .btn-lightblue:active {
    background-color: #0077aa;
  }
</style>

<script>
  function generateMatrixFields() {
    const matrixSize = document.getElementById('matrix_size').value;
    const matrixContainer = document.getElementById('matrix_inputs_container');

    // Clear any existing inputs
    matrixContainer.innerHTML = '';

    let html = '<div class="d-flex justify-content-center">';

    // Generate matrix A fields
    html += '<div class="matrix-container"><label class="matrix-label">Matriz A</label><table class="matrix-table">';
    for (let i = 0; i < matrixSize; i++) {
      html += '<tr>';
      for (let j = 0; j < matrixSize; j++) {
        html += `<td><input type="number" name="A_${i}_${j}" class="matrix-input" placeholder="A[${i+1}][${j+1}]" step="any"></td>`;
      }
      html += '</tr>';
    }
    html += '</table></div>';

    // Generate vector b fields
    html += '<div class="vector-container mx-3"><label class="matrix-label">Vector b</label><table class="matrix-table">';
    for (let i = 0; i < matrixSize; i++) {
      html += `<tr><td><input type="number" name="b_${i}" class="matrix-input" placeholder="b[${i+1}]" step="any"></td></tr>`;
    }
    html += '</table></div>';

    // Generate vector x0 fields
    html += '<div class="vector-container"><label class="matrix-label">Vector x0</label><table class="matrix-table">';
    for (let i = 0; i < matrixSize; i++) {
      html += `<tr><td><input type="number" name="x0_${i}" class="matrix-input" placeholder="x0[${i+1}]" step="any"></td></tr>`;
    }
    html += '</table></div></div>';

    // Insert generated HTML into container
    matrixContainer.innerHTML = html;
  }

  function loadExample(exampleNumber) {
    let matrixSize = 3;
    let matrixA = [
      [4, -1, 0],
      [-1, 4, -1],
      [0, -1, 3]
    ];
    let vectorB = [15, 10, 10];
    let vectorX0 = [0, 0, 0];

    if (exampleNumber === 2) {
      matrixSize = 2;
      matrixA = [
        [3, 1],
        [1, 2]
      ];
      vectorB = [5, 5];
      vectorX0 = [0, 0];
    }

    document.getElementById('matrix_size').value = matrixSize;
    generateMatrixFields();

    for (let i = 0; i < matrixSize; i++) {
      for (let j = 0; j < matrixSize; j++) {
        const input = document.querySelector(`input[name="A_${i}_${j}"]`);
        if (input) {
          input.value = matrixA[i][j];
        }
      }
    }

    for (let i = 0; i < matrixSize; i++) {
      const input = document.querySelector(`input[name="b_${i}"]`);
      if (input) {
        input.value = vectorB[i];
      }
      const inputX0 = document.querySelector(`input[name="x0_${i}"]`);
      if (inputX0) {
        inputX0.value = vectorX0[i];
      }
    }
  }

  function generateRandomValues() {
    const matrixSize = document.getElementById('matrix_size').value;
    generateMatrixFields();

    for (let i = 0; i < matrixSize; i++) {
      for (let j = 0; j < matrixSize; j++) {
        const input = document.querySelector(`input[name="A_${i}_${j}"]`);
        if (input) {
          input.value = (Math.random() * 20 - 10).toFixed(2);
        }
      }
    }

    for (let i = 0; i < matrixSize; i++) {
      const input = document.querySelector(`input[name="b_${i}"]`);
      if (input) {
        input.value = (Math.random() * 20 - 10).toFixed(2);
      }
      const inputX0 = document.querySelector(`input[name="x0_${i}"]`);
      if (inputX0) {
        inputX0.value = (Math.random() * 20 - 10).toFixed(2);
      }
    }
  }
</script>

{% endblock %}
